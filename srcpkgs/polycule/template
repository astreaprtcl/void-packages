# Template file for 'polycule'
pkgname=polycule
version=0.3.4
revision=1
archs="x86_64"
makedepends="base-devel git which cmake ninja clang gtk+3-devel libsecret-devel alsa-lib-devel mpv-devel mimalloc-devel openssl-devel rustup"
depends="mpv gtk+3 alsa-lib libsecret mimalloc openssl libnotify dbus xdg-user-dirs"
short_desc="Geeky and efficient [matrix] client for power users"
maintainer="Astreaprtcl <git@m-woerle.de>"
license="EUPL"
homepage="https://gitlab.com/polycule_client/polycule"
_flutter=3.35.1
_appid=business.braid.polycule
distfiles="https://gitlab.com/polycule_client/polycule/-/archive/v${version}/polycule-v${version}.tar.gz
 https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${_flutter}-stable.tar.xz"
checksum="cd452a14ef7843aaba8e80d627bfdcdd120ab1396ece7dbb9f895da3ed754dd5
 58efd9d1e570a1bf976e218cfbbcca3f23b21b873d765a74e045d5b9022ab515"

do_build() {
	rustup-init -y
	export PATH=$PATH:$PWD/flutter/bin
	cd polycule*
	flutter --disable-analytics
	export PUBSPEC_VERSION=$(grep -m1 version pubspec.yaml | awk '{ print $2 }' | cut -f1 -d "+")
	export FLUTTER_ARGS="--no-pub --release --dart-define=POLYCULE_IS_STABLE=true --dart-define=POLYCULE_VERSION=$version --dart-define=no_default_http_client=true --dart-define=cronetHttpNoPlay=true"
	flutter pub get
	flutter gen-l10n
	flutter build linux -v $FLUTTER_ARGS
}

do_install() {
	cd polycule*
	vinstall linux/${_appid}.desktop 644 usr/share/applications
	vinstall linux/${_appid}-daemon.desktop 644 usr/share/applications
	vinstall linux/${_appid}.service 644 usr/share/dbus-1/services
	vinstall linux/${_appid}.metainfo.xml 644 usr/share/metainfo
	vlicense LICENSE
	vinstall assets/logo/logo-circle.svg 644 usr/share/pixmaps ${_appid}.svg
	vinstall assets/logo/logo-circle.svg 644 usr/share/icons/hicolor/scalable/apps ${_appid}.svg

	cd build/linux/x64/release/bundle
	vmkdir usr/lib/polycule
	vcopy * usr/lib/polycule
	vmkdir usr/bin
	ln -s /usr/lib/polycule/polycule $DESTDIR/usr/bin/polycule
}
